<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>New Tab</title>
	<style type="text/css">
	body {
		padding: 0;
		margin: 0;
	}
	.column {
		float:left;
		position:relative;
		height: 100%;
		border-right:1px solid #eee;
	}
	.node {
		border: 1px solid transparent;
		position: relative;
	}
	.group {
		background-color: #eee;
	}
	.bookmark {
		cursor: hand;
		padding: 2px 0px 2px 5px;
	}
	.mouseover {
		border: 1px solid #eee;
	}
	.dim {
		background-color: #aaa;
	}
	.deleteButton{
		position:absolute;
		right:0;
		top: 0;
		bottom: 0;
		padding: 0 5px;
		vertical-align: middle;
	}
	.delMouseover {
		background-color: #fee;
	}
	#deleteConfirm {
		cursor: pointer;
	}
	#deleteConfirm>span {
		cursor: hand;
		padding: 0 3px;
	}
	#yes {
		border: 1px solid green;
	}
	.yesMouseover{
		background-color: #efe;
	}
	#no {
		border: 1px solid red;
	}
	.noMouseover{
		background-color: #fee;
	}
	</style>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script tyep="text/javascript">
	$(document).ready(function() {
		var colwidth = 250;
		var fullwidth = $(document).width();
		var totalcolumns = 0;
		var curcol = 0
		var toBeDeleted;
		
		function addColumn() {
			$('<div><div class="inner"></div></div>')
				.attr('id','column'+totalcolumns)
				.addClass('column')
				.css({'width':colwidth})
				.appendTo($('#columns'));
			totalcolumns++;
		}
		addColumn();
		
		$('.node')
			.live('mouseover mouseout',
				function(e){
					if (e.type == 'mouseover') {
						$(this).addClass('mouseover');
						$(this).children('.deleteButton').show();
					} else {
						$(this).removeClass('mouseover');
						$(this).children('.deleteButton').hide();
					}
				}
			);
		$('.deleteButton')
			.live('mouseover mouseout',
				function(e){
					if(e.type == 'mouseover') {
						$(this).addClass('delMouseover');
					} else {
						$(this).removeClass('delMouseover');
					}
				}
			);
		$('#yes')
			.bind('mouseover mouseout',
				function(e){
					if(e.type == 'mouseover') {
						$(this).addClass('yesMouseover');
					} else {
						$(this).removeClass('yesMouseover');
					}
				})
			.click(
				function(e){
					chrome.bookmarks.remove(toBeDeleted.attr('nodeID'));
					$('#deleteConfirm').hide();
					$('#columns').empty();
					totalcolumns= 0;
					curcol = 0;
					addColumn();
					layoutNodes();
				});
		$('#no')
			.bind('mouseover mouseout',
				function(e){
					if(e.type == 'mouseover') {
						$(this).addClass('noMouseover');
					} else {
						$(this).removeClass('noMouseover');
					}
				})
			.click(
				function(e){
					$('#deleteConfirm').hide();
				});
		function makeGroupNode(n) {
			g =  $('<div></div>')
				.addClass('node').addClass('group')
				.text(n.title)
			g.node = n;
			return g;
		}
		function makeBookmarkNode(n) {
			b = $('<div></div>')
				.addClass('node').addClass('bookmark')
				.text(n.title)
				.click(function(){
					chrome.tabs.getSelected(null,function(curtab){
						chrome.tabs.update(curtab.id, {url: n.url});
					});
				});
			d = $('<div>del</div>')
				.addClass('deleteButton')
				.click(function(e){
					$('#deleteConfirm')
						.css({'top':(e.pageY - ($('#deleteConfirm').height() / 2) - 1), 
						      'left':(e.pageX - ($('#deleteConfirm').width() / 2))})
						.show();
					toBeDeleted = $(this).parent();
					return false;
				})
				.hide();
			b.attr('nodeID',n.id);
			b.append(d);
			b.node = n;
			return b;
		}
		
		function addNode(n) {
			n
				.attr('name',n.node.title.toLowerCase())
				.appendTo('#column'+curcol+'>.inner')
			if ($('#column'+curcol+'>.inner').height() > $('#column'+curcol).height()) {
				addColumn();
				$('#column'+curcol+'>.inner').children(':last').appendTo('#column'+(curcol+1)+'>.inner');
				curcol++;
			}
		}
		function processBookmarkNode(n) {
			var omitted = localStorage['OmittedBookmarkGroups'].split(',');
			if (omitted) {
				for(var i=0; i<omitted.length; i++) {
					if(n.id == omitted[i]) {
						return;
					}
				}
			}
			if(n.url) {
				addNode(makeBookmarkNode(n));
			} else {
				if(n.title == 'Temporary') {
					addColumn();
					curcol++
				}
				if(n.title != 'Other Bookmarks') {
					addNode(makeGroupNode(n));
				}
				for (var i=0; i<n.children.length; i++) {
					processBookmarkNode(n.children[i]);
				}
			}
		}
		function layoutNodes() {
			chrome.bookmarks.getTree(function(tree){
				for (var i=0; i<tree.length; i++) {
					processBookmarkNode(tree[i]);
				}
			});
		}
		layoutNodes();
		$('#filter')
			.focus(function(){
				var $me = $(this);
				if ($me.val() == '(filter)') {
					$me.val('').css({color:'#000'});
				}
			})
			.blur(function(){
				var $me = $(this);
				if ($me.val() == '') {
					$me.val('(filter)').css({color:'#aaa'});
				}
			})
			.keyup(function(){
				$me = $(this);
				$('.node').addClass('dim')
				$('.node[name*='+$me.val().toLowerCase()+']').removeClass('dim');
			})
		$('#options').click(function(){
			chrome.tabs.create({url: "options.html"});
		})
	});
	</script>
</head>
<body>
	<div id="ui" style="positin:absolute; top:0; left:0; right:0; height:2em;">
		<input id="filter" type="text" value="(filter)" style="position:relative; top:50%; margin-top:-1em; left:0.5em; color:#aaa"/>
		<a id="options" style="position:absolute; right: 0.5em; top: 0.5em; height: 1em; cursor: pointer; color:#aaa">options</a>
	</div>
	<div>
	<div id="columns" style="position:absolute; top:2em; bottom:0; left:0; right:0; border-top:1px solid #eee">
	</div>
	<div id="deleteConfirm" style="position:absolute; padding: 3px; background-color: white; border: 1px solid red; display: none;">
		delete? <span id="yes">yes</span>&nbsp;<span id="no">no</span></div>
</body>
</html>
